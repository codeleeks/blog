## 세션 인증 방식과 토큰 인증 방식

||세션 인증 방식|토큰 인증 방식|
|---|---|---|
|원리|로그인 성공시 서버에서 세션을 생성하고 cookie 형태로 반환한다. <br />이후 모든 클라이언트 요청에 쿠키가 포함된다.|로그인 성공시 서버에서 토큰을 발행하고, 클라이언트는 권한이 필요한 요청을 할 때 토큰을 넣어 보낸다|
|저장 위치|세션은 서버의 메모리에 저장되며, 쿠키는 브라우저에 저장된다|토큰은 서버의 DB나 메모리에 저장가능하며(개발자의 몫), 브라우저에서는 로컬스토리지나 쿠키를 이용한다|
|장점|서버는 세션을 임의로 무효화할 수 있다|DB에 저장할 경우 세션 인증 방식보다는 서버의 부하를 줄일 수 있다.|
|단점|서버의 메모리에 저장되기 때문에 동시에 많은 사용자가 로그인한 경우 메모리 부하가 온다|서버는 이미 발급한 토큰을 자체적으로 무효화할 수 있는 방법이 없다|

일반적으로 토큰 인증 방식이 사용된다고 한다.

서버의 부하를 줄일 수 있다는 점이 매력적이고, 단점으로 지적된 토큰 무효화 불가능에 대해선 해결책이 있기 때문이다. (추후 예제로 살펴본다)

## JWT (JSON Web Token) 인증 방식

JWT 인증 방식은 토큰 인증 방식의 대표적인 구현체이다.

JWT는 JSON 형태의 구조를 갖고, .(period)로 구분된 세 개의 필드(Header, Payload, Signature)로 구성된다.

![image](https://github.com/codeleeks/blog/assets/166087781/836c3d3e-deb5-444c-9a82-d55cd0e5a65c)

json의 키-값의 쌍을 클레임이라고 부른다.

Payload에는 예약된 클레임과 커스텀 클레임을 넣을 수 있는데,

예약된 클레임은 `iss`, 'exp' 등이 있다.
- `iss`: issuer
- `exp`: expiration time

더 알아보려면, [Registered Claims](https://datatracker.ietf.org/doc/html/rfc7519#section-4.1)를 참조하자.

커스텈 클레임은 원하는 값을 키-밸류 형태로 정의하면 된다.

```json
{
  "sub": "1234567890",
  "name": "John Doe",
  "iat": 1516239022
}
```

## JWT 인증 기반 로그인 예제

프론트엔드는 `React`를 사용했고, 백엔드는 `Spring Boot`를 사용했다.

### Normal Case

![image](https://github.com/codeleeks/blog/assets/166087781/4863a0da-8d17-442f-9348-afded00b2b6f)


mermaid code
```
sequenceDiagram
    Frontend->>+Backend: login(id, pwd)
    Backend->>-Frontend: return refresh token, access token (wii be saved to browser store)
    Frontend->>+Backend: /items (the request required the authentication)
    Backend->>-Frontend: list of items (success)
```

### access token이 만료된 케이스

![image](https://github.com/codeleeks/blog/assets/166087781/53c3be60-4412-4ae8-8411-589685a83462)

memmaid code
```
sequenceDiagram
    Frontend->>+Backend: /items (the request required the authentication)
    Backend->>-Frontend: return UNAUTHORIZED response
    Frontend->>+Backend: /refresh (also sending refresh token)
    Backend->>-Frontend: generate and return refresh token, access token
    Frontend->>+Backend: /items (with the new refresh token and access token)
    Backend->>-Frontend: list of items (success)
```

### refresh token이 만료된 케이스

클라이언트에서 refresh token이 만료됨을 인지하고, 로그인 화면으로 전환한다.

cookie에 토큰들을 저장하고 있고, 이 쿠키가 만료되면 context에 저장된 token
