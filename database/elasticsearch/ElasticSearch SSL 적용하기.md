---
summary: ElasticSearch SSL 적용하기
date: 2024-08-05
title-image: ''
---

## CA 발급

2년(730days) 만료로 잡음.

```bash
.\bin\elasticsearch-certutil ca --days 730
warning: ignoring JAVA_HOME=C:\Program Files\Java\jdk-17; using bundled JDK
This tool assists you in the generation of X.509 certificates and certificate
signing requests for use with SSL/TLS in the Elastic stack.

The 'ca' mode generates a new 'certificate authority'
This will create a new X.509 certificate and private key that can be used
to sign certificate when running in 'cert' mode.

Use the 'ca-dn' option if you wish to configure the 'distinguished name'
of the certificate authority

By default the 'ca' mode produces a single PKCS#12 output file which holds:
    * The CA certificate
    * The CA's private key

If you elect to generate PEM format certificates (the -pem option), then the output will
be a zip file containing individual files for the CA certificate and private key

Please enter the desired output file [elastic-stack-ca.p12]: [엔터]
Enter password for elastic-stack-ca.p12 : [패스워드 설정]
```

`elastic-stack-ca.p12` 파일이 현재 폴더에 생김.

## 노드 간 통신에 사용되는 인증서 발급

```bash
.\bin\elasticsearch-certutil cert --ca .\elastic-stack-ca.p12
warning: ignoring JAVA_HOME=C:\Program Files\Java\jdk-17; using bundled JDK
This tool assists you in the generation of X.509 certificates and certificate
signing requests for use with SSL/TLS in the Elastic stack.

The 'cert' mode generates X.509 certificate and private keys.
    * By default, this generates a single certificate and key for use
       on a single instance.
    * The '-multiple' option will prompt you to enter details for multiple
       instances and will generate a certificate and key for each one
    * The '-in' option allows for the certificate generation to be automated by describing
       the details of each instance in a YAML file

    * An instance is any piece of the Elastic Stack that requires an SSL certificate.
      Depending on your configuration, Elasticsearch, Logstash, Kibana, and Beats
      may all require a certificate and private key.
    * The minimum required value for each instance is a name. This can simply be the
      hostname, which will be used as the Common Name of the certificate. A full
      distinguished name may also be used.
    * A filename value may be required for each instance. This is necessary when the
      name would result in an invalid file or directory name. The name provided here
      is used as the directory name (within the zip) and the prefix for the key and
      certificate files. The filename is required if you are prompted and the name
      is not displayed in the prompt.
    * IP addresses and DNS names are optional. Multiple values can be specified as a
      comma separated string. If no IP addresses or DNS names are provided, you may
      disable hostname verification in your SSL configuration.


    * All certificates generated by this tool will be signed by a certificate authority (CA)
      unless the --self-signed command line option is specified.
      The tool can automatically generate a new CA for you, or you can provide your own with
      the --ca or --ca-cert command line options.


By default the 'cert' mode produces a single PKCS#12 output file which holds:
    * The instance certificate
    * The private key for the instance certificate
    * The CA certificate

If you specify any of the following options:
    * -pem (PEM formatted output)
    * -multiple (generate multiple certificates)
    * -in (generate certificates from an input file)
then the output will be be a zip file containing individual certificate/key files

Enter password for CA (elastic-stack-ca.p12) : [CA 패스워드 입력]
Please enter the desired output file [elastic-certificates.p12]: [엔터]
Enter password for elastic-certificates.p12 : [패스워드 설정]

Certificates written to C:\Users\leeka\Documents\dev\github\workspace\elasticsearch\elasticsearch-8.14.3-windows-x86_64\elasticsearch-8.14.3\elastic-certificates.p12

This file should be properly secured as it contains the private key for
your instance.
This file is a self contained file and can be copied and used 'as is'
For each Elastic product that you wish to configure, you should copy
this '.p12' file to the relevant configuration directory
and then follow the SSL configuration instructions in the product guide.

For client applications, you may only need to copy the CA certificate and
configure the client to trust this certificate.
```

`elastic-certificates.p12` 파일이 현재 폴더에 생성됨.

## 엘라스틱서치 서버 인증서 발급

```bash
.\bin\elasticsearch-certutil http
...
Generate a CSR? [y/N] [N 선택]
...
Use an existing CA? [y/N] [y 선택]
...
CA Path: elastic-stack-ca.p12 (안적으면 config에서 찾기 때문에 파일을 config 폴더로 옮겨야 함)
...
Password for elastic-stack-ca.p12: [패스워드 설정]
...
For how long should your certificate be valid? [5y] [2y 입력]
...
Generate a certificate per node? [y/N] [N 입력]
...
Enter all the hostnames that you need, one per line.
When you are done, press <ENTER> once more to move on to the next step.
[엔터 입력] (추후 AWS 같은 퍼블릭 환경에서 domain name을 적어야 할 수도 있다)

You did not enter any hostnames.
Clients are likely to encounter TLS hostname verification errors if they
connect to your cluster using a DNS name.

Is this correct [Y/n] [Y 입력]
...
Enter all the IP addresses that you need, one per line.
When you are done, press <ENTER> once more to move on to the next step.
[엔터 입력] (추후 AWS 같은 퍼블릭 환경에서 노드 ip을 적어야 할 수도 있다)

You did not enter any IP addresses.

Is this correct [Y/n] [Y 입력]
...
## Other certificate options

The generated certificate will have the following additional configuration
values. These values have been selected based on a combination of the
information you have provided above and secure defaults. You should not need to
change these values unless you have specific requirements.

Key Name: elasticsearch
Subject DN: CN=elasticsearch
Key Size: 2048

Do you wish to change any of these options? [y/N] [N 입력]
...
If you wish to use a blank password, simply press <enter> at the prompt below.
Provide a password for the "http.p12" file:  [<ENTER> for none] [패스워드 설정]
Repeat password to confirm: [패스워드 확인]
...
What filename should be used for the output zip file? [C:\Users\leeka\Documents\dev\github\workspace\elasticsearch\elasticsearch-8.14.3-windows-x86_64\elasticsearch-8.14.3\elasticsearch-ssl-http.zip] [엔터 입력]
Zip file written to C:\Users\leeka\Documents\dev\github\workspace\elasticsearch\elasticsearch-8.14.3-windows-x86_64\elasticsearch-8.14.3\elasticsearch-ssl-http.zip
```

이렇게 하면 현재 폴더에 `elasticsearch-ssl-http.zip` 압축 파일이 생기고, 들어가면 `http.p12` 파일을 볼 수 있다.
이것이 엘라스틱서치 서버의 인증서이다.

## elasticsearch 설정 파일 수정

생성된 인증서를 설정 파일에 명시한다.

```yml
xpack.security.enabled: true

xpack.security.enrollment.enabled: true

# Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents
xpack.security.http.ssl:
  enabled: true
  keystore.path: certs/http.p12

# Enable encryption and mutual authentication between cluster nodes
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: certs/elastic-certificates.p12
  truststore.path: certs/elastic-certificates.p12
```

## 각 인증서에 대한 비밀번호 설정

http 인증서는 클라이언트와의 보안 연결을 위한 인증서이다.

transport 인증서는 클러스터 내 노드 간 보안 연결을 위한 인증서이다.

각 인증서에 대한 keystore, truststore의 비밀번호를 설정해야 한다.

```bash
 .\bin\elasticsearch-keystore add xpack.security.http.ssl.keystore.secure_password
warning: ignoring JAVA_HOME=C:\Program Files\Java\jdk-17; using bundled JDK
Setting xpack.security.http.ssl.keystore.secure_password already exists. Overwrite? [y/N]y
Enter value for xpack.security.http.ssl.keystore.secure_password: [패스워드 설정]

 .\bin\elasticsearch-keystore add xpack.security.http.ssl.truststore.secure_password
warning: ignoring JAVA_HOME=C:\Program Files\Java\jdk-17; using bundled JDK
Enter value for xpack.security.http.ssl.truststore.secure_password:[패스워드 설정]

.\bin\elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password
warning: ignoring JAVA_HOME=C:\Program Files\Java\jdk-17; using bundled JDK
Setting xpack.security.transport.ssl.keystore.secure_password already exists. Overwrite? [y/N]y
Enter value for xpack.security.transport.ssl.keystore.secure_password:[패스워드 설정]

 .\bin\elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password
warning: ignoring JAVA_HOME=C:\Program Files\Java\jdk-17; using bundled JDK
Setting xpack.security.transport.ssl.truststore.secure_password already exists. Overwrite? [y/N]y
Enter value for xpack.security.transport.ssl.truststore.secure_password:[패스워드 설정]
```

## 엘라스틱서치 리부트

```bash
./bin/elasticsearch.bat
```

## Spring Data ElasticSearch와 연동하기

```yml
spring:
  datasource:
    url: jdbc:postgresql://localhost/blogmain
    username: [postgresql 아이디]
    password: [postgresql 비밀번호]
  jpa:
    hibernate:
      ddl-auto: create
    show-sql: true
    open-in-view: false
  ssl:
    bundle:
      pem:
        client:
          truststore:
            certificate: [pem 파일 경로]

my:
  elasticsearch:
    username: [아이디]
    password: [비밀번호]

logging:
  level:
    tracer: trace
```

```java
package blog.main;

import lombok.Data;
import lombok.Getter;
import lombok.RequiredArgsConstructor;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.boot.ssl.NoSuchSslBundleException;
import org.springframework.boot.ssl.SslBundles;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.elasticsearch.client.ClientConfiguration;
import org.springframework.data.elasticsearch.client.elc.ElasticsearchConfiguration;

import javax.net.ssl.*;
import java.security.KeyManagementException;
import java.security.NoSuchAlgorithmException;
import java.security.cert.X509Certificate;

@Configuration
public class ElasticSearchClientConfig extends ElasticsearchConfiguration {
    private final SSLContext sslContext;
    private final BasicAuthConfig basicAuthConfig;


    public ElasticSearchClientConfig(SslBundles sslBundles, BasicAuthConfig basicAuthConfig) throws NoSuchSslBundleException {
        this.sslContext = sslBundles.getBundle("client").createSslContext();
        this.basicAuthConfig = basicAuthConfig;
    }

    @Override
    public ClientConfiguration clientConfiguration() {
        return ClientConfiguration.builder()
                .connectedTo("localhost:9200")
               //TODO allHostsValid를 인증서에 있는 CN으로 고쳐야 함.
                .usingSsl(sslContext, allHostsValid())
                .withBasicAuth(basicAuthConfig.getUsername(), basicAuthConfig.getPassword())
                .build();
    }

   //ssl 무시하는 코드.
    public static SSLContext disableSslVerification() {
        try {
            // ============================================
            // trust manager 생성(인증서 체크 전부 안함)
            TrustManager[] trustAllCerts = new TrustManager[]{new X509TrustManager() {
                public java.security.cert.X509Certificate[] getAcceptedIssuers() {
                    return null;
                }

                public void checkClientTrusted(X509Certificate[] certs, String authType) {
                }

                public void checkServerTrusted(X509Certificate[] certs, String authType) {
                }
            }};

            // trust manager 설치
            SSLContext sc = SSLContext.getInstance("SSL");
            sc.init(null, trustAllCerts, new java.security.SecureRandom());
            HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());

            return sc;
        } catch (NoSuchAlgorithmException | KeyManagementException e) {
            e.printStackTrace();
        }
        return null;
    }

    public static HostnameVerifier allHostsValid() {

        // ============================================
        // host name verifier 생성(호스트 네임 체크안함)
        HostnameVerifier allHostsValid = (hostname, session) -> true;

        // host name verifier 설치
        HttpsURLConnection.setDefaultHostnameVerifier(allHostsValid);
        return allHostsValid;

    }

    @ConfigurationProperties("my.elasticsearch")
    @Configuration
    @Data
    public static class BasicAuthConfig {
        private String username;
        private String password;
    }
}
```

## 참고

[이 블로그보고 많이 참고해서 성공함!](https://velog.io/@jhchoi94/%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EA%B5%AC%EC%84%B1-%EB%8B%A8%EC%9D%BC-%EA%B5%AC%EC%84%B1)

https://daram.tistory.com/549


https://www.elastic.co/guide/en/elasticsearch/reference/current/security-basic-setup-https.html

자바 코드 관련

https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/current/_encrypted_communication.html

https://www.baeldung.com/spring-boot-security-ssl-bundles

https://spring.io/blog/2023/06/07/securing-spring-boot-applications-with-ssl
